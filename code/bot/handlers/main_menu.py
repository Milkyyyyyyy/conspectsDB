"""
–í —ç—Ç–æ–º —Ñ–∞–π–ª–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é (–ø–æ–∫–∞ —á—Ç–æ —ç—Ç–æ —Ç–æ–ª—å–∫–æ —Å–∞–º–æ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∏ –≤—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ)
"""

from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton

from code.bot.bot_instance import bot
from code.bot.callbacks import vote_cb
from code.bot.services.user_service import get_user_info
from code.bot.utils import get_greeting, send_temporary_message
from code.logging import logger
from code.bot.services.requests import request
from code.bot.services.validation import validators
from code.database.queries import update
from code.database.service import connect_db

async def main_menu(user_id, chat_id, previous_message_id=None):
	logger.info(f'User({user_id}) is requesting main menu.')

	greeting = await get_greeting()
	# –°–æ–±–∏—Ä–∞–µ–º markup
	markup = InlineKeyboardMarkup()
	show_info = InlineKeyboardButton('–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ üë§', callback_data='show_info')
	markup.row(show_info)
	try:
		if previous_message_id is None:
			message = await bot.send_message(chat_id=chat_id, text=greeting, reply_markup=markup, parse_mode='HTML')
			logger.info("Sent new main menu message to user=%s chat=%s message_id=%s",
			            user_id, chat_id, getattr(message, "message_id", getattr(message, "id", None)))
		else:
			try:
				await bot.edit_message_text(text=greeting, chat_id=chat_id, message_id=previous_message_id,
												parse_mode='HTML')
				await bot.edit_message_reply_markup(chat_id=chat_id, message_id=previous_message_id, reply_markup=markup)
				logger.info("Edited existing message %s with main menu for user=%s chat=%s",
				            previous_message_id, user_id, chat_id)
			except Exception as e:
				logger.error("Can't edit message with id {%s}", previous_message_id)
	except Exception as e:
		logger.error(f'Unexpected error: {e}')

@bot.callback_query_handler(func=lambda call: call.data == 'show_info')
async def call_show_info(call):
	# –û—Ç–≤–µ—Ç –Ω–∞ callback
	try:
		await bot.answer_callback_query(call.id)
	except Exception as e:
		logger.exception('Failed to answer callback query for user=%s', getattr(call.from_user, 'id', None))

	# –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ callback
	user_id = call.from_user.id
	chat_id = call.message.chat.id
	previous_message_id = call.message.id
	username = call.from_user.username

	logger.debug("Callback show_info: user_id=%s chat_id=%s previous_message_id=%s",
	             user_id, chat_id, previous_message_id)
	await print_user_info(user_id=user_id, chat_id=chat_id, previous_message_id=previous_message_id, username=username)

async def print_user_info(user_id=None, chat_id=None, previous_message_id=None, username=None):
	logger.info("Showing user info: user_id=%s chat_id=%s message_id=%s", user_id, chat_id, previous_message_id)
	try:
		user_info = await get_user_info(chat_id=chat_id, user_id=user_id)
	except Exception as e:
		logger.exception(f"Failed to get user_info for user=%s chat=%s", user_id, chat_id)
		await send_temporary_message(bot, chat_id, '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞')
		return

	text_message = ("<blockquote><b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</b>\n\n"
					f"<b>–ò–º—è</b>: {user_info['name']}\n"
					f"<b>–§–∞–º–∏–ª–∏—è</b>: {user_info['surname']}\n"
					f"<b>–Æ–∑–µ—Ä–Ω–µ–π–º</b>: @{username}\n\n"
					f"<b>–£—á–µ–±–Ω–∞—è –≥—Ä—É–ø–ø–∞</b>: {user_info['study_group']}\n"
					f"<b>–§–∞–∫—É–ª—å—Ç–µ—Ç</b>: {user_info['facult_name']}\n"
					f"<b>–ö–∞—Ñ–µ–¥—Ä–∞</b>: {user_info['chair_name']}\n"
					f"<b>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</b>: {user_info['direction_name']}\n\n"
					f"<b>–ö–æ–ª-–≤–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Å–ø–µ–∫—Ç–æ–≤</b>: –í –†–ê–ó–†–ê–ë–û–¢–ö–ï</blockquote>")
	markup = InlineKeyboardMarkup()
	back_button = InlineKeyboardButton('–ù–∞–∑–∞–¥',
									   callback_data=vote_cb.new(action='open menu', amount=str(previous_message_id)))
	change_name_button = InlineKeyboardButton('–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è', callback_data='change_name')
	change_surname_button = InlineKeyboardButton('–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–∞–º–∏–ª–∏—é', callback_data='change_surname')
	markup.row(change_name_button, change_surname_button)
	markup.row(back_button)
	try:
		if previous_message_id is None or not isinstance(previous_message_id, int):
			# –ï—Å–ª–∏ id —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
			sent = await bot.send_message(chat_id=chat_id, text=text_message, reply_markup=markup, parse_mode='HTML')
			logger.info("Sent user info as new message to chat=%s message_id=%s", chat_id,
			            getattr(sent, "message_id", getattr(sent, "id", None)))
		else:
			await bot.edit_message_text(text=text_message,
			                            chat_id=chat_id,
			                            message_id=previous_message_id,
			                            parse_mode='HTML')
			await bot.edit_message_reply_markup(chat_id=chat_id, message_id=previous_message_id, reply_markup=markup)
			logger.info("Updated message %s with user info for user=%s", previous_message_id, user_id)
	except Exception:
		logger.exception("Failed to display user info for user=%s chat=%s", user_id, chat_id)
		try:
			await send_temporary_message(bot, chat_id, text='–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.',
			                             delay_seconds=3)
		except Exception:
			logger.exception("Also failed to send fallback error message to chat=%s", chat_id)

@bot.callback_query_handler(func=lambda call: call.data == 'change_name')
async def change_name(call):
	try:
		await bot.answer_callback_query(call.id)
	except Exception:
		logger.exception("Failed to answer callback_query (change_name) for user=%s",
		                 getattr(call.from_user, "id", None))

	user_id, chat_id, username = call.from_user.id, call.message.chat.id, call.from_user.username
	logger.info("Initiating change_name for user=%s chat=%s", user_id, chat_id)

	name = None
	try:
		name = await request(
			user_id=user_id,
			chat_id=chat_id,
			timeout=30,
			validator=validators.name,
			request_message='–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è:'
		)
	except Exception as e:
		logger.exception("Request for new name failed for user=%s chat=%s", user_id, chat_id)
		return
	if not isinstance(name, str):
		logger.info('User %s provided invalid name input: %r', user_id, name)
		await send_temporary_message(bot, chat_id, text='–ò–º—è –Ω–µ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ.', delay_seconds=10)
		return

	updated = None
	try:
		async with connect_db() as db:
			updated = await update(
				database=db,
				values=[name,],
				table='USERS',
				columns=['name'],
				filters={'telegram_id': user_id}
			)
			logger.info("Database update result for user=%s: %r", user_id, updated)
	except Exception as e:
		logger.exception(f'Database update failed for user=%s\n{e}', user_id)
		await send_temporary_message(bot, chat_id, text='–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞!', delay_seconds=5)
		return
	finally:
		text = '–û–±–Ω–æ–≤–ª–µ–Ω–æ' if updated else '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å'
		await send_temporary_message(bot, chat_id, text=text, delay_seconds=3)
		await print_user_info(user_id=user_id, chat_id=chat_id, previous_message_id=call.message.message_id, username=username)

@bot.callback_query_handler(func=lambda call: call.data == 'change_surname')
async def change_surname(call):
	try:
		await bot.answer_callback_query(call.id)
	except Exception:
		logger.exception("Failed to answer callback_query for user=%s",
		                 getattr(call.from_user, "id", None))

	user_id, chat_id, username = call.from_user.id, call.message.chat.id, call.from_user.username
	logger.info("Initiating change_name for user=%s chat=%s", user_id, chat_id)

	surname = None
	try:
		surname = await request(
			user_id=user_id,
			chat_id=chat_id,
			timeout=30,
			validator=validators.surname,
			request_message='–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Ñ–∞–º–∏–ª–∏—é:'
		)
	except Exception as e:
		logger.exception("Request for new name failed for user=%s chat=%s", user_id, chat_id)
		return
	if not isinstance(surname, str):
		logger.info('User %s provided invalid name input: %r', user_id, surname)
		await send_temporary_message(bot, chat_id, text='–§–∞–º–∏–ª–∏—è –Ω–µ –±—ã–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∞.', delay_seconds=10)
		return

	updated = None
	try:
		async with connect_db() as db:
			updated = await update(
				database=db,
				values=[surname,],
				table='USERS',
				columns=['surname'],
				filters={'telegram_id': user_id}
			)
			logger.info("Database update result for user=%s: %r", user_id, updated)
	except Exception as e:
		logger.exception(f'Database update failed for user=%s\n{e}', user_id)
		await send_temporary_message(bot, chat_id, text='–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞!', delay_seconds=5)
		return
	finally:
		text = '–û–±–Ω–æ–≤–ª–µ–Ω–æ' if updated else '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å'
		await send_temporary_message(bot, chat_id, text=text, delay_seconds=3)
		await print_user_info(user_id=user_id, chat_id=chat_id, previous_message_id=call.message.message_id, username=username)
